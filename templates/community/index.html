<!-- filepath: d:\DarkMatter\LanguageLearning\templates\community\index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#2DB9FF',
              secondary: '#0AA1FF',
              brand: {
                white: '#EFF4F6',
                btwhite: '#D7DBDF80',
                gray: '#959A9D',
                hover: '#2DB9FF26'
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-brand-white min-h-screen">
    <!-- Header -->
    <div class="bg-brand-white px-4 py-3 flex items-center justify-center relative">
        <div class="absolute left-4 top-1/2 -translate-y-1/2 flex items-center">
            <i class="fas fa-arrow-left text-primary text-xl"></i>
        </div>
        <h1 class="text-gray-800 text-lg font-medium w-full text-center">Community</h1>
    </div>

    <!-- Navigation Bar -->
    <div class="bg-brand-white border-b border-gray-200 shadow-lg px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-brand-btwhite rounded-xl px-4 py-2 h-10">
                        <i class="fas fa-plus text-gray-700"></i>
                    </div>
                    <div class="flex items-center space-x-2 bg-brand-btwhite rounded-xl px-4 py-2 h-10">
                        <i class="fas fa-home text-gray-700"></i>
                        <span class="text-brand-gray font-medium">Home</span>
                    </div>
                    <div class="flex items-center space-x-2 text-brand-gray rounded-xl px-4 py-2 h-10">
                        <i class="fas fa-film"></i>
                        <span class='text-brand-gray font-medium'>Reels</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <i class="fas fa-search text-primary text-xl"></i>
                <i class="fas fa-bell text-primary text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-2xl mx-auto p-4 space-y-4" id="post-container">
        <!-- Post Input -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-3">
            <div class="flex items-center space-x-3">
                <img src="{{ user.avatar_url|default:'https://img.freepik.com/free-vector/blue-circle-with-white-user_78370-4707.jpg?semt=ais_incoming&w=740&q=80' }}" 
                     alt="Profile" class="w-10 h-10 rounded-full">
                <input type="text" id="new-post-input" placeholder="Post your question, thoughts" 
                       class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-gray-700 placeholder-gray-500">
                <button id="post-btn" class="ml-2 px-4 py-2 bg-primary text-white rounded-lg font-semibold">Post</button>
            </div>
        </div>

        <!-- Posts will be loaded here -->
        <div id="posts-list"></div>
        <div id="loading" class="text-center py-4 text-brand-gray hidden">Loading...</div>
        <div id="end-message" class="text-center py-4 text-brand-gray hidden">No more posts.</div>
    </div>

    <script>
        let page = 1;
        const pageSize = 10;
        let loading = false;
        let hasMore = true;

        function renderPost(post) {
            return `
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-4">
                <div class="flex items-center space-x-3 mb-3">
                    <img src="${post.users.avatar_url || 'https://img.freepik.com/free-vector/blue-circle-with-white-user_78370-4707.jpg?semt=ais_incoming&w=740&q=80'}" 
                         alt="${post.users.display_name || 'User'}" class="w-10 h-10 rounded-full">
                    <div>
                        <h3 class="font-semibold text-gray-800">${post.users.display_name || 'Anonymous'}</h3>
                        <p class="text-gray-500 text-sm flex items-center">
                            <i class="fas fa-clock mr-1"></i>${post.created_at ? new Date(post.created_at).toLocaleString() : ''}
                        </p>
                    </div>
                </div>
                <p class="text-gray-800 border-b border-brand-gray py-2 px-2 mb-3 text-lg">${post.content || ''}</p>
                <div class="flex items-center justify-center border-b border-brand-gray pb-3 space-x-6 mb-4">
                    <button class="flex items-center space-x-2 bg-brand-btwhite px-3 py-1 rounded-xl">
                        <i class="fas fa-arrow-up"></i>
                        <span class="font-medium">${post.upvotes || 0}</span>
                    </button>
                    <button class="flex items-center space-x-2 bg-brand-btwhite hover:bg-brand-hover px-3 py-1 rounded-xl">
                        <i class="fas fa-arrow-down"></i>
                        <span>${post.downvotes || 0}</span>
                    </button>
                    <button class="flex items-center space-x-2 bg-brand-btwhite px-3 py-1 rounded-xl">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments_count || 0}</span>
                    </button>
                    <button class="flex items-center space-x-2 bg-brand-btwhite px-3 py-1 rounded-xl">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
            </div>
            `;
        }

        function loadPosts() {
            if (loading || !hasMore) return;
            loading = true;
            document.getElementById('loading').classList.remove('hidden');
            fetch(`/community/post?page=${page}&page_size=${pageSize}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loading').classList.add('hidden');
                    if (data.success) {
                        const postsList = document.getElementById('posts-list');
                        data.posts.forEach(post => {
                            postsList.insertAdjacentHTML('beforeend', renderPost(post));
                        });
                        hasMore = data.has_more;
                        if (!hasMore) {
                            document.getElementById('end-message').classList.remove('hidden');
                        }
                        page += 1;
                    } else {
                        alert(data.error || "Failed to load posts.");
                    }
                    loading = false;
                })
                .catch(() => {
                    document.getElementById('loading').classList.add('hidden');
                    alert("Error loading posts.");
                    loading = false;
                });
        }

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                loadPosts();
            }
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
        });

        // Post creation (dummy, needs backend POST endpoint)
        document.getElementById('post-btn').addEventListener('click', function() {
            const input = document.getElementById('new-post-input');
            const content = input.value.trim();
            if (!content) return;
            // TODO: Implement actual POST request to backend
            alert('Post creation is not implemented in frontend yet.');
            input.value = '';
        });
    </script>
</body>
</html>