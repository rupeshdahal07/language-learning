{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl p-8 mb-6">
            <h1 class="text-4xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
                Users Management
            </h1>
            <p class="text-center text-gray-600" id="total-count">Loading users...</p>
            
            <!-- Add New User Button -->
            <div class="text-center mt-4">
                <a href="{% url 'create_user' %}" 
                   class="inline-block bg-gradient-to-r from-green-500 to-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Add New User
                </a>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6">
            <span id="error-text"></span>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="search-input" placeholder="Search users by name or email..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="refresh-btn" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <!-- Users List Container -->
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl">
            <!-- List Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-t-2xl p-4 border-b border-gray-200">
                <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-700">
                    <div class="col-span-1 text-center">Avatar</div>
                    <div class="col-span-3">Name</div>
                    <div class="col-span-3">Email</div>
                    <div class="col-span-2">Joined</div>
                    <div class="col-span-1 text-center">Status</div>
                    <div class="col-span-2 text-center">Actions</div>
                </div>
            </div>

            <!-- Users List -->
            <div id="users-list" class="divide-y divide-gray-100">
                <!-- Users will be loaded here dynamically -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="p-8 text-center">
                <div class="flex items-center justify-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="text-gray-600">Loading users...</span>
                </div>
            </div>

            <!-- Load More Button -->
            <div id="load-more-container" class="hidden p-6 text-center border-t border-gray-100">
                <button id="load-more-btn" 
                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold">
                    Load More Users
                </button>
            </div>

            <!-- No More Users Message -->
            <div id="no-more-users" class="hidden p-6 text-center border-t border-gray-100">
                <p class="text-gray-500">You've reached the end of the list</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-8">
                <div class="text-gray-500 mb-4">
                    <svg class="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-medium text-gray-700 mb-2">No Users Found</h3>
                <p class="text-gray-500 mb-4">Get started by creating your first user account.</p>
                <a href="{% url 'create_user' %}" 
                   class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Create First User
                </a>
            </div>
        </div>
    </div>
</div>

<script>
class UsersList {
    constructor() {
        this.currentPage = 1;
        this.limit = 20;
        this.hasMore = true;
        this.loading = false;
        this.searchTimeout = null;
        
        this.init();
    }
    
    init() {
        this.loadUsers();
        this.setupEventListeners();
        this.setupInfiniteScroll();
    }
    
    setupEventListeners() {
        // Load more button
        document.getElementById('load-more-btn').addEventListener('click', () => {
            this.loadMoreUsers();
        });
        
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', () => {
            this.refreshUsers();
        });
        
        // Search input
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.searchUsers(e.target.value);
            }, 500);
        });
    }
    
    setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
            if (this.loading || !this.hasMore) return;
            
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 1000) {
                this.loadMoreUsers();
            }
        });
    }
    
    async loadUsers(reset = false) {
        if (this.loading) return;
        
        this.loading = true;
        this.showLoading();
        
        if (reset) {
            this.currentPage = 1;
            document.getElementById('users-list').innerHTML = '';
        }
        
        try {
            const response = await fetch(`{% url 'list_users' %}?page=${this.currentPage}&limit=${this.limit}`);
            const data = await response.json();
            
            if (data.error) {
                this.showError(data.error);
                return;
            }
            
            this.hideError();
            this.renderUsers(data.users, reset);
            this.updateTotalCount(data.total_count);
            this.hasMore = data.has_more;
            this.currentPage++;
            
            this.updateLoadMoreButton();
            
        } catch (error) {
            this.showError('Failed to load users');
            console.error('Error loading users:', error);
        } finally {
            this.loading = false;
            this.hideLoading();
        }
    }
    
    loadMoreUsers() {
        this.loadUsers(false);
    }
    
    refreshUsers() {
        this.loadUsers(true);
    }
    
    searchUsers(query) {
        // For now, we'll implement client-side search
        // You can extend this to use server-side search
        const userRows = document.querySelectorAll('.user-row');
        
        userRows.forEach(row => {
            const name = row.querySelector('.user-name').textContent.toLowerCase();
            const email = row.querySelector('.user-email').textContent.toLowerCase();
            const searchQuery = query.toLowerCase();
            
            if (name.includes(searchQuery) || email.includes(searchQuery)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    renderUsers(users, reset = false) {
        const container = document.getElementById('users-list');
        
        if (reset) {
            container.innerHTML = '';
        }
        
        if (users.length === 0 && reset) {
            this.showEmptyState();
            return;
        }
        
        this.hideEmptyState();
        
        users.forEach(user => {
            const userRow = this.createUserRow(user);
            container.appendChild(userRow);
        });
    }
    
    createUserRow(user) {
        const row = document.createElement('div');
        row.className = 'user-row p-4 hover:bg-gray-50 transition-colors duration-200';
        
        const avatarUrl = user.avatar_url || '';
        const displayName = user.display_name || user.name || 'No Name';
        const joinedDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
        
        row.innerHTML = `
            <div class="grid grid-cols-12 gap-4 items-center">
                <!-- Avatar -->
                <div class="col-span-1 flex justify-center">
                    ${avatarUrl ? 
                        `<img src="${avatarUrl}" alt="${displayName}'s Avatar" 
                             class="w-12 h-12 rounded-full border-2 border-blue-200 object-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="hidden w-12 h-12 rounded-full border-2 border-gray-200 bg-gradient-to-r from-blue-400 to-purple-500 items-center justify-center">
                             <span class="text-lg font-bold text-white">${displayName.charAt(0).toUpperCase()}</span>
                         </div>` :
                        `<div class="w-12 h-12 rounded-full border-2 border-gray-200 bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
                             <span class="text-lg font-bold text-white">${displayName.charAt(0).toUpperCase()}</span>
                         </div>`
                    }
                </div>
                
                <!-- Name -->
                <div class="col-span-3">
                    <div class="user-name font-semibold text-gray-800">${displayName}</div>
                    ${user.id ? `<div class="text-xs text-gray-500">ID: ${user.id}</div>` : ''}
                </div>
                
                <!-- Email -->
                <div class="col-span-3">
                    <div class="user-email text-gray-600 break-words">${user.email}</div>
                </div>
                
                <!-- Joined Date -->
                <div class="col-span-2">
                    <div class="text-sm text-gray-600">${joinedDate}</div>
                </div>
                
                <!-- Status -->
                <div class="col-span-1 text-center">
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                        Active
                    </span>
                </div>
                
                <!-- Actions -->
                <div class="col-span-2 flex justify-center space-x-2">
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                            title="Edit User">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                            title="Delete User">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <a href="mailto:${user.email}" 
                       class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
                       title="Contact User">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </a>
                </div>
            </div>
        `;
        
        return row;
    }
    
    updateTotalCount(count) {
        document.getElementById('total-count').textContent = `Total Users: ${count}`;
    }
    
    updateLoadMoreButton() {
        const loadMoreContainer = document.getElementById('load-more-container');
        const noMoreUsers = document.getElementById('no-more-users');
        
        if (this.hasMore) {
            loadMoreContainer.classList.remove('hidden');
            noMoreUsers.classList.add('hidden');
        } else {
            loadMoreContainer.classList.add('hidden');
            noMoreUsers.classList.remove('hidden');
        }
    }
    
    showLoading() {
        document.getElementById('loading-indicator').classList.remove('hidden');
    }
    
    hideLoading() {
        document.getElementById('loading-indicator').classList.add('hidden');
    }
    
    showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').classList.remove('hidden');
    }
    
    hideError() {
        document.getElementById('error-message').classList.add('hidden');
    }
    
    showEmptyState() {
        document.getElementById('empty-state').classList.remove('hidden');
    }
    
    hideEmptyState() {
        document.getElementById('empty-state').classList.add('hidden');
    }
}

// Initialize the users list when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new UsersList();
});
</script>

<style>
/* Custom styles for smooth animations */
.user-row {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Loading spinner animation */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* Responsive grid adjustments */
@media (max-width: 768px) {
    .grid.grid-cols-12 {
        grid-template-columns: 1fr;
        gap: 2px;
    }
    
    .col-span-1, .col-span-2, .col-span-3 {
        grid-column: span 1;
    }
    
    .user-row .grid {
        display: block;
    }
    
    .user-row .grid > div {
        margin-bottom: 8px;
        padding: 4px 0;
    }
}
</style>
{% endblock content %}