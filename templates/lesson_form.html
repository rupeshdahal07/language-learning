{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl p-8">
        <h1 class="text-4xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-8">
            Create Lesson
        </h1>
        
        <form id="lessonForm" method="POST" action="{% url 'create_lesson' %}" class="space-y-6">
            <!-- CSRF Token placeholder - Django will populate this -->
            {% csrf_token %}
            
            <div>
                <label for="lessonTitle" class="block text-sm font-semibold text-gray-700 mb-2">
                    Lesson Title
                </label>
                <input 
                    type="text" 
                    id="lessonTitle" 
                    name="lessonTitle" 
                    required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 outline-none"
                    placeholder="Enter lesson title"
                >
            </div>

            <div>
                <label for="lessonDescription" class="block text-sm font-semibold text-gray-700 mb-2">
                    Description (Optional)
                </label>
                <textarea 
                    id="lessonDescription" 
                    name="lessonDescription" 
                    rows="3"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 outline-none resize-none"
                    placeholder="Enter lesson description"
                ></textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-4">
                    Lesson Type & Levels
                </label>
                <div id="levelContainer" class="space-y-4">
                    <!-- Initial level entry will be added here by JavaScript -->
                </div>
                
                <button 
                    type="button" 
                    id="addLevelBtn"
                    class="mt-4 w-full bg-gradient-to-r from-green-500 to-teal-600 text-white font-medium py-2 px-4 rounded-lg hover:from-green-600 hover:to-teal-700 transition-all duration-200 shadow-md hover:shadow-lg"
                >
                    + Add Another Level
                </button>
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 px-6 rounded-xl hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl"
            >
                Create Lesson
            </button>
        </form>
    </div>
</div>

<script>
    const levelContainer = document.getElementById('levelContainer');
    const addLevelBtn = document.getElementById('addLevelBtn');
    let levelCount = 0;

    // Lesson types mapping
    const lessonTypes = {
        0: 'Hiragana',
        1: 'Katakana', 
        2: 'Kanji'
    };

    // Add initial level entry
    addLevelEntry();

    // Add level button event
    addLevelBtn.addEventListener('click', addLevelEntry);

    function addLevelEntry() {
        const levelDiv = document.createElement('div');
        levelDiv.className = 'bg-gray-50 p-4 rounded-xl border-2 border-gray-100';
        levelDiv.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-800">Level Configuration ${levelCount + 1}</h3>
                ${levelCount > 0 ? `
                    <button 
                        type="button" 
                        class="remove-level text-red-500 hover:text-red-700 font-medium text-sm"
                        onclick="removeLevelEntry(this)"
                    >
                        Remove
                    </button>
                ` : ''}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">
                        Lesson Type
                    </label>
                    <select 
                        name="level_type_${levelCount}" 
                        required
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 outline-none lesson-type-select"
                        data-level-index="${levelCount}"
                    >
                        <option value="">Select type</option>
                        <option value="1">Quiz</option>
                        <option value="2">Word Game</option>
                        <option value="3">Match the following</option>
                        <option value="4">Word Form</option>
                        <option value="5">Fill in the Blanks</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">
                        Level ID
                    </label>
                    <select 
                        name="level_id_${levelCount}" 
                        required
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 outline-none level-id-select"
                    >
                        <option value="">Select level</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">
                        Sub Level ID
                    </label>
                    <select 
                        name="sub_level_id_${levelCount}" 
                        required
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all duration-200 outline-none"
                    >
                        <option selected value="0">Sub Level 0</option>
                        
                    </select>
                </div>
            </div>
        `;
        
        levelContainer.appendChild(levelDiv);

        // Add event listener for the new lesson type select
        const lessonTypeSelect = levelDiv.querySelector('.lesson-type-select');
        const levelIdSelect = levelDiv.querySelector('.level-id-select');
        lessonTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            // Call backend for level IDs
            fetch(`/get-level-ids/?type=${selectedType}`)
                .then(response => response.json())
                .then(data => {
                    // Clear previous options
                    levelIdSelect.innerHTML = '<option value="">Select level</option>';
                    // Populate new options
                    data.level_ids.forEach(id => {
                        const opt = document.createElement('option');
                        opt.value = id.value;
                        opt.textContent = id.label;
                        levelIdSelect.appendChild(opt);
                    });
                })
                .catch(() => {
                    levelIdSelect.innerHTML = '<option value="">Select level</option>';
                });
        });

        levelCount++;
    }

    function removeLevelEntry(button) {
        const levelDiv = button.closest('.bg-gray-50');
        levelDiv.remove();
        updateLevelNumbers();
    }

    function updateLevelNumbers() {
        const levelDivs = levelContainer.querySelectorAll('.bg-gray-50');
        levelDivs.forEach((div, index) => {
            const title = div.querySelector('h3');
            title.textContent = `Level Configuration ${index + 1}`;
        });
    }

    // Form submission handler
    document.getElementById('lessonForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const lessonData = {
            title: formData.get('lessonTitle'),
            description: formData.get('lessonDescription') || '',
            levels: []
        };

        // Collect all level configurations
        const levelDivs = levelContainer.querySelectorAll('.bg-gray-50');
        levelDivs.forEach((div, index) => {
            const levelType = formData.get(`level_type_${index}`);
            const levelId = formData.get(`level_id_${index}`);
            const subLevelId = formData.get(`sub_level_id_${index}`);
            
            if (levelType !== null && levelId !== null && subLevelId !== null) {
                lessonData.levels.push({
                    level_id: parseInt(levelId),
                    level_type: parseInt(levelType),
                    sub_level_id: parseInt(subLevelId)
                });
            }
        });

        console.log('Lesson Data:', lessonData);
        
        // You can uncomment this line to actually submit the form
        this.submit();
        
        // For demo purposes, show the data
        alert('Lesson data prepared! Check console for details.');
    });
</script>
{% endblock content %}